<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Extending SafeModel &mdash; GRAIMATTER 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Examples" href="examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> GRAIMATTER
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="preprocessing.html">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="attacks.html">Attacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="safemodel.html">Base Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="safedecisiontree.html">SafeDecisionTree</a></li>
<li class="toctree-l1"><a class="reference internal" href="saferandomforest.html">SafeRandomForest</a></li>
<li class="toctree-l1"><a class="reference internal" href="safekeras.html">SafeKerasModel</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Extending SafeModel</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#modular-design">Modular Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="#copy-the-template">Copy The Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="#define-the-safer-class">Define the Safer Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="#update-rules-json-file">Update rules.json file</a></li>
<li class="toctree-l2"><a class="reference internal" href="#update-the-init-method-with-paramnames-ignore-items-and-examine-separately-items">Update the __init__ method with paramnames, ignore_items, and examine_separately items</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-checks-for-any-unusual-data-structures">Add checks for any unusual data structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#override-the-fit-function">Override the fit() function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#update-sphinx-documentation">Update Sphinx documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#write-pytests-to-confirm-core-functionality">Write pytests to confirm core functionality</a></li>
<li class="toctree-l2"><a class="reference internal" href="#include-any-optional-helper-functions">Include any optional helper functions</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GRAIMATTER</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Extending SafeModel</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/extending.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="extending-safemodel">
<h1>Extending SafeModel<a class="headerlink" href="#extending-safemodel" title="Permalink to this heading"></a></h1>
<section id="modular-design">
<h2>Modular Design<a class="headerlink" href="#modular-design" title="Permalink to this heading"></a></h2>
<p>The safemodel package is an opensource wrapper for common machine learning
models. It is designed to be modular and can be extended for use with other
models. Code comments should be in the numpydoc format so that they are rendered
by the automatic sphinx documentation</p>
<p>The main steps needed to implement a new model are:</p>
<p># Copy the new_model_template.py
# Define a safer class inheriting SafeModel and the Basic (SkLearn) model
# Update the __init__ method with ignore_items and examine_separately items
# Add checks for any unusual data structures
# Override the fit() function
# Update Sphinx documentation
# Write pytests to confirm core functionality
# Include any optional helper functions</p>
</section>
<section id="copy-the-template">
<h2>Copy The Template<a class="headerlink" href="#copy-the-template" title="Permalink to this heading"></a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cp new_model_template xgboost.py
</pre></div>
</div>
</section>
<section id="define-the-safer-class">
<h2>Define the Safer Class<a class="headerlink" href="#define-the-safer-class" title="Permalink to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SafeGradientBoosting</span><span class="p">(</span><span class="n">SafeModel</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Privacy protected GradientBoostingClassifier.&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="update-rules-json-file">
<h2>Update rules.json file<a class="headerlink" href="#update-rules-json-file" title="Permalink to this heading"></a></h2>
<p>The rules.json file is used to define safe limits for pearameters.
The file is written in JSON (JavaScript Object Notation) and can be extended.
to define safe limits for parameters of newly implemented models.</p>
</section>
<section id="update-the-init-method-with-paramnames-ignore-items-and-examine-separately-items">
<h2>Update the __init__ method with paramnames, ignore_items, and examine_separately items<a class="headerlink" href="#update-the-init-method-with-paramnames-ignore-items-and-examine-separately-items" title="Permalink to this heading"></a></h2>
<p>Code for a new class needs to reflect is the contents of the list self.basemodel_paramnames.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SafeModelToMakeSafe</span><span class="p">(</span><span class="n">SafeModel</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Privacy protected XGBoost.&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates model and applies constraints to params&quot;&quot;&quot;</span>
        <span class="n">SafeModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">basemodel_paramnames</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;edit&#39;</span><span class="p">,</span><span class="s1">&#39;this&#39;</span><span class="p">,</span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="s1">&#39;to&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contain&#39;</span><span class="p">,</span><span class="s1">&#39;just&#39;</span><span class="p">,</span><span class="s1">&#39;the&#39;</span><span class="p">,</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span>
        <span class="s1">&#39;for&#39;</span><span class="p">,</span><span class="s1">&#39;the&#39;</span><span class="p">,</span><span class="s1">&#39;class&#39;</span><span class="p">,</span>
        <span class="s1">&#39;you &#39;</span><span class="p">,</span><span class="s1">&#39;are&#39;</span><span class="p">,</span><span class="s1">&#39;creating&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span>
        <span class="s1">&#39;safe&#39;</span><span class="p">,</span><span class="s1">&#39;wrapper&#39;</span><span class="p">,</span><span class="s1">&#39;version&#39;</span><span class="p">,</span><span class="s1">&#39;of&#39;</span><span class="p">]</span>

        <span class="n">the_kwds</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basemodel_paramnames</span><span class="p">:</span>
                <span class="n">the_kwds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">val</span>
        <span class="n">ModelToMakeSafer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">the_kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ModelToMakeSafer&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">preliminary_check</span><span class="p">(</span><span class="n">apply_constraints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_items</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;model_save_file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ignore_items&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base_estimator_&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">examine_seperately_items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;base_estimator&quot;</span><span class="p">,</span> <span class="s2">&quot;estimators_&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>For sklearn models this list can be extracted from the sklearn man page for the new model. For example,
Saferandomforest defines the valid paramnames as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates model and applies constraints to params&quot;&quot;&quot;</span>
        <span class="n">SafeModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basemodel_paramnames</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">,</span><span class="s1">&#39;criterion&#39;</span><span class="p">,</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span><span class="s1">&#39;min_samples_split&#39;</span><span class="p">,</span>
        <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">,</span><span class="s1">&#39;min_weight_fraction_leaf&#39;</span><span class="p">,</span><span class="s1">&#39;max_features&#39;</span><span class="p">,</span>
        <span class="s1">&#39;max_leaf_nodes&#39;</span><span class="p">,</span><span class="s1">&#39;min_impurity_decrease&#39;</span><span class="p">,</span><span class="s1">&#39;bootstrap&#39;</span><span class="p">,</span>
        <span class="s1">&#39;oob_score&#39;</span><span class="p">,</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">,</span><span class="s1">&#39;random_state&#39;</span><span class="p">,</span><span class="s1">&#39;verbose&#39;</span>
        <span class="s1">&#39;warm_start&#39;</span><span class="p">,</span><span class="s1">&#39;class_weight&#39;</span><span class="p">,</span><span class="s1">&#39;ccp_alpha&#39;</span><span class="p">,</span><span class="s1">&#39;max_samples&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="add-checks-for-any-unusual-data-structures">
<h2>Add checks for any unusual data structures<a class="headerlink" href="#add-checks-for-any-unusual-data-structures" title="Permalink to this heading"></a></h2>
<p>Some models may have unusual datastructures.
Care should be taken to ensure that these are not changed after the fit() method
is called.</p>
<p>Examples of unusual datastructures are:
Lists are handled in the safemodel base class.
Decision Trees handled in safedecisiontree.py and saferandomforest.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SafeGradientBoosting</span><span class="p">(</span><span class="n">SafeModel</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Privacy protected GradientBoostingClassifier.&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="override-the-fit-function">
<h2>Override the fit() function<a class="headerlink" href="#override-the-fit-function" title="Permalink to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do fit and then store model dict&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_anonymity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_k_anonymity</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="update-sphinx-documentation">
<h2>Update Sphinx documentation<a class="headerlink" href="#update-sphinx-documentation" title="Permalink to this heading"></a></h2>
<p>In the Sphinx docs/source directory make a copy of an existing .rst file
it the .rst to reflect the newly implemented class. Then you must update the
index.rst file by to include the new .rst file, although the extension is
not required. E.g. saferandomforest links in saferandomforest.rst</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> docs
cp saferandomforest.rst xgboost.rst
edit xgboost.rst
edit index.rst
</pre></div>
</div>
</section>
<section id="write-pytests-to-confirm-core-functionality">
<h2>Write pytests to confirm core functionality<a class="headerlink" href="#write-pytests-to-confirm-core-functionality" title="Permalink to this heading"></a></h2>
<p>Write pytests to confirm the corefunctionality.
Example test suites can be found in AI-SDC/tests/</p>
</section>
<section id="include-any-optional-helper-functions">
<h2>Include any optional helper functions<a class="headerlink" href="#include-any-optional-helper-functions" title="Permalink to this heading"></a></h2>
<p>Depending on the model being implemented one or more helper functions or
methods may be required. For example there are may helpfunctions in
safekeras.py that help with the the specifics of neural networks.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">same_weights</span><span class="p">(</span><span class="n">m1</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">m2</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;different numbers of layers&quot;</span>
<span class="n">numlayers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numlayers</span><span class="p">):</span>
        <span class="n">m1layer</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
        <span class="n">m2layer</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m1layer</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m2layer</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2"> not the same size.&quot;</span>
<span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m1layer</span><span class="p">)):</span>
    <span class="n">m1d</span> <span class="o">=</span> <span class="n">m2layer</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
    <span class="n">m2d</span> <span class="o">=</span> <span class="n">m2layer</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
    <span class="c1"># print(type(m1d), m1d.shape)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">m1d</span><span class="p">,</span> <span class="n">m2d</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;dimension </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2"> of layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2"> differs&quot;</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;weights match&quot;</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="examples.html" class="btn btn-neutral float-left" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, GRAIMATTER Project Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>